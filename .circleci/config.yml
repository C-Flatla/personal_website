version: 2

# Variables
anchor_1: &job_defaults
  working_directory: ~/personal-website
  docker:
    - image: circleci/node:12.3.1-browsers

jobs:
  pre_build:
    <<: *job_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependency-cache-{{ checksum "package-lock.json" }}
            - v1-dependency-cache-
      - run:
          name: install-dependencies
          command: npm install --no-progress
      - save_cache:
          key: v1-dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - run:
          name: angular-lint
          command: npm run-script lint
      - store_artifacts:
          path: tslint.xml
          prefix: lint
      - run:
          name: angular-test
          command: npm run-script test-once
      - store_artifacts:
          path: test-results.xml
          prefix: tests

  build:
    <<: *job_defaults
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependency-cache-{{ checksum "package-lock.json" }}
            - v1-dependency-cache-
      - run:
          name: install-dependencies
          command: npm install --no-progress
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules
      - run:
          name: angular-build --prod
          command: npm run-script build-prod
      - save_cache:
          key: v1-dist-{{ .Environment.CIRCLE_BRANCH }}-{{ .Environment.CIRCLE_SHA1 }}
          paths:
            - ./dist

  deploy:
    working_directory: ~/personal-website
    machine: true
    steps:
      - restore_cache:
          keys:
            - v1-dist-{{ .Environment.CIRCLE_BRANCH }}-{{ .Environment.CIRCLE_SHA1 }}
            - v1-dist-{{ .Environment.CIRCLE_BRANCH }}-
      - run:
          name: add-ssh-known-host
          command: ssh-keyscan $DROPLET_HOST >> ~/.ssh/known_hosts
      - run:
          name: remove-old-files
          command: ssh circleci@codyflatla.ca "rm -rf /var/www/codyflatla.ca/html/*"
      - run:
          name: deploy-using-scp
          command: |
            mv ~/personal-website/dist/assets/favicon ~/
            # -p preserves modification times, access times, and modes from the original file
            # -r recursively copy entire directories
            # -q quietly
            scp -prq ~/personal-website/dist/* circleci@codyflatla.ca:/var/www/codyflatla.ca/html/
            scp -prq ~/favicon/* circleci@codyflatla.ca:/var/www/codyflatla.ca/html/

workflows:
  version: 2
  default_workflow:
    jobs:
      - pre_build
      - build:
          requires:
            - pre_build
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - pre_build
            - build
          filters:
            branches:
              only: master
